---
title: "EvolutionVariance"
author: "Yimen"
date: "8/20/2021"
output: html_document
---

```{r setup, include=FALSE}
library(arm)
library(parallel)
require(MCMCglmm)
require(dplyr)
require(INLA)
```

```{r simulatePedigree, include=FALSE}
simPed<-function(n=100, gen=5, nrep=10, Va=1, VBd=1, Vxd=1, VBr=1, Vxr=1, Br=4, Bd=4, xd_bar=4, xr_bar=4){
ped<-list()

Sire<-1:(n/2)
Dam<-(n/2+1):n
pedF<-data.frame(Sire=0, Dam=0, ID=c(Sire, Dam), year=1)
pedF$a<-rnorm(n, 0, sqrt(Va))
pedF$Bd<-rnorm(n, Bd, sqrt(VBd))
pedF$Br<-rnorm(n, Br, sqrt(VBr))
pedF$xd<-rnorm(nrow(pedF), xd_bar, sqrt(Vxd))
ped[[1]]<-pedF

for(i in 2:gen){
pedO<-ped[[i-1]]
pednew<-data.frame(Sire=rep(sample(pedO$ID[1:(n/2)]),2), Dam=rep(sample(pedO$ID[((n/2)+1):n]),each=2))
pednew$ID=(pedO$ID[n]+1):(pedO$ID[n]+n)
pednew$year=i
pednew$a=(pedO$a[match(pednew$Sire,pedO$ID)]+pedO$a[match(pednew$Dam, pedO$ID)])/2 + rnorm(n,0,sqrt(Va/2))
pednew$Bd=(pedO$Bd[match(pednew$Sire,pedO$ID)]+pedO$Bd[match(pednew$Dam, pedO$ID)])/2 + rnorm(n,0,sqrt(VBd/2))
pednew$Br=(pedO$Br[match(pednew$Sire,pedO$ID)]+pedO$Br[match(pednew$Dam, pedO$ID)])/2 + rnorm(n,0,sqrt(VBr/2))
pednew$xd<-rnorm(nrow(pednew), xd_bar, sqrt(Vxd))

ped[[i]]<-pednew
}

d<-do.call(rbind.data.frame, ped)
d$animal<-d$ID

d2<-d[rep(seq_len(nrow(d)), each=nrep),]
d2$xr<-rnorm(nrow(d2), xr_bar, sqrt(Vxr))
d2$z<-d2$a +  d2$xd*d2$Bd + d2$xr*d2$Br 

res<-list(d=d, d2=d2, par=data.frame(n, gen, nrep, Va, VBd, Vxd, VBr, Vxr, xd_bar, xr_bar))
res
}
```

```{r simulateSelection, include=FALSE}
selection<-function(res, Bl=0, Bq=0, BBd=0, BBr=0){
Vxd<-res$par$Vxd
Vxr<-res$par$Vxr
n<-res$par$n
nrep<-res$par$nrep
gen<-res$par$gen
xd_bar=res$par$xd_bar
xr_bar=res$par$xr_bar

d2<-res$d2[res$d2$year==res$par$gen,]
d2$z_bar<-(d2$a + d2$Bd*d2$xd)
d2$dev1<-(d2$z_bar-mean(d2$z_bar))^2
d2$dev2<-(d2$z-d2$z_bar)^2

w<-1 + Bl*d2$z_bar + Bq*d2$dev1 + BBd*d2$Bd + BBr*d2$Br
d2$w<-(w+max(abs(w)))/mean(w+max(abs(w)))

d2$off<-rpois(length(d2$w), d2$w)
d<-d2[-which(duplicated(d2$ID)),]

pedlast<-data.frame(Sire=rep(sample(d$ID[1:(n/2)]),2), Dam=rep(sample(d$ID[((n/2)+1):n]),each=2))

indexDam<-match(pedlast$Dam,d$ID)
indexSire<-match(pedlast$Sire,d$ID)

pedlast$atmp<-(d$a[indexDam] + d$a[indexSire])/2 
pedlast$Bdtmp<-(d$Bd[indexDam] + d$Bd[indexSire])/2
pedlast$Brtmp<-(d$Br[indexDam] + d$Br[indexSire])/2 

pedlast$OffDam<-d$off[indexDam]
pedlast$OffSire<-d$off[indexSire]
pedlast$off<- pedlast$OffDam + pedlast$OffSire

pedlast2<-pedlast[rep(seq_len(nrow(pedlast)), times=pedlast$off),]
pedlast2$a<-pedlast2$atmp + rnorm(nrow(pedlast2), 0, sqrt(var(pedlast2$atmp)))
pedlast2$Bd<-pedlast2$Bdtmp + rnorm(nrow(pedlast2), 0, sqrt(var(pedlast2$Bdtmp)))
pedlast2$Br<-pedlast2$Brtmp + rnorm(nrow(pedlast2), 0, sqrt(var(pedlast2$Brtmp)))
pedlast2$xd<-rnorm(nrow(pedlast2), xd_bar, sqrt(Vxd))
pedlast2$ID<- (n*gen+1):((n*gen)+nrow(pedlast2))

d4<-pedlast2[rep(seq_len(nrow(pedlast2)), each=nrep),]
d4$xr<-rnorm(nrow(d4), xr_bar, sqrt(Vxr))
d4$z<-d4$a +  d4$xd*d4$Bd + d4$xr*d4$Br 

par2<-res$par
par2$Bl<-Bl
par2$Bq<-Bq
par2$BBr<-BBr
par2$BBr<-BBr
par2$mw<-mean(w+max(abs(w)))
res<-list(d4=d4, par=par2, d=d, d2=d2)
res
}


```

```{r AnalyzesFunctions, include=FALSE}

obs.var<-function (x){
varres<-data.frame(VID=var(x$a+x$Bd*x$xd), VIDsqrt=var((x$a+x$Bd*x$xd)^2),VRes=var(x$xr*x$Br), VRessqrt=var((x$xr*x$Br))^2, Va=var(x$a), Vasqrt=var(x$a^2), Vpe=var(x$Bd*x$xd), Vpesqrt=var((x$Bd*x$xd)^2), Bd=mean(x$Bd), Br=mean(x$Br), Vxd=var(x$xd), Vxr=var(x$xr), VBd=var(x$Bd), VBr=var(x$Br), mxd=mean(x$xd))}

obs.var1<-function (x){
  x2<-x %>% group_by(ID) %>%
  mutate(zMean = mean(z))

  x2<-as.data.frame(x2)  
  x2$dev1<-(x2$zMean-mean(x2$zMean))
  x2$dev2<-(x2$z-x2$zMean)
  varres<-data.frame(z=mean(x2$z), VID=var(x2$dev1), VRes=var(x2$dev2))
  varres
}

obs.var2<-function (x){
  mod<-lmer(z~1+ (1|ID), data=x)
  varres<-data.frame(z=fixef(mod)[1], VID=VarCorr(mod)$ID[,], VRes=attr(VarCorr(mod), "sc")^2)
  varres
}



GPdev<-function(x){
dev1<-(x$a+x$Bd*x$xd)^2
v<-coef(lm(dev1~x$Bd))[2]^2*var(x$Bd)
as.data.frame(v)
}

selAn<-function(x){
  x2<-x %>% group_by(ID) %>%
  mutate(zMean = mean(z))

  x2<-as.data.frame(x2)  
  x2$dev1<-(x2$zMean-mean(x2$zMean))^2
  x2$dev2<-(x2$z-x2$zMean)^2
   
  x3<-x2 %>% group_by(ID) %>%
  summarize(w=mean(off), mean.z = mean(zMean), mean.dev1=mean(dev1), mean.dev2=mean(dev2))

  s<-lm(w~mean.z +  mean.dev1 + mean.dev2, data=x3)
  res<-data.frame(Int=coef(s)[1], bl=coef(s)[2]/mean(x3$w), bv1=coef(s)[3]/mean(x3$w), bv2=coef(s)[4]/mean(x3$w))
}

```

```{r EstGFunctions, include=FALSE}

animal<-function(x){
  ped<-x[-which(duplicated(x$ID)),c(3,2,1)]
  colnames(ped)<-c("animal","dam", "sire")
  ped$sire[ped$sire==0]<-NA
  ped$dam[ped$dam==0]<-NA  
  x$ID2<-x$ID
colnames(ped)<-c("ID","dam.id","sire.id")

Cmatrix <- inverseA(ped[,c("ID","dam.id","sire.id")])$Ainv
ainv<-inverseA(ped[,])

prec.2=list( param = c(0.1,0.01))
prec.3 = list(param = c(0.5, 0.5), fixed = FALSE)

formula = z ~ 1  + f(ID2 ,model="iid", hyper=list(
      prec=prec.2)) +
  f(ID,model="generic0",
    Cmatrix=Cmatrix,
    hyper=list(
      prec=prec.2
    )
  )



mod1.Inla = inla(formula=formula, family="gaussian",
                 data=x,
                 control.compute=list(dic=T, config=T)
)


  # summary(mod)
  res<-data.frame(Va=1/mod1.Inla$summary.hyperpar$`0.5quant`[3]
)
  res
}

animal1<-function(x){
  ped<-x[-which(duplicated(x$ID)),c(3,2,1)]
  colnames(ped)<-c("animal","dam", "sire")
  ped$sire[ped$sire==0]<-NA
  ped$dam[ped$dam==0]<-NA  
  
  x2<-x %>% group_by(ID) %>%
    mutate(zMean = mean(z))
  x2<-as.data.frame(x2)  
  
  x2$dev1<-(x2$zMean-mean(x2$zMean))^2
  x2$dev2<-(x2$z-x2$zMean)^2
  x3<-x2 %>% group_by(ID) %>%
    summarize(z=mean(zMean), dev1=mean(dev1), dev2=mean(dev2))
  x3$animal<-x3$ID
  x3<-as.data.frame(x3)
 
#x3$dev1<-x3$dev1-mean(x3$dev1)   
colnames(ped)<-c("ID","dam.id","sire.id")

Cmatrix <- inverseA(ped[,c("ID","dam.id","sire.id")])$Ainv
ainv<-inverseA(ped[,])

prec.1 = list(initial=log(1/2), prior="pc.prec",param=c(1,0.05), fixed=FALSE)
prec.2=list( param = c(0.1,0.01))
prec.3 = list(param = c(0.5, 0.5), fixed = FALSE)


formula = dev1 ~ 1  +
  f(ID,model="generic0",
    Cmatrix=Cmatrix,
    hyper=list(
      prec=prec.3 
    )
  )



mod1.Inla = inla(formula=formula, family="gaussian",
                 data=x3,
                 control.compute=list(dic=T, config=T)
)


  # summary(mod)
  res<-data.frame(Va=1/mod1.Inla$summary.hyperpar$`0.5quant`[2]
)
  res
}


animal1mm<-function(x){
  ped<-x[-which(duplicated(x$ID)),c(3,2,1)]
  colnames(ped)<-c("animal","dam", "sire")
  ped$sire[ped$sire==0]<-NA
  ped$dam[ped$dam==0]<-NA  
  
  mod<-lmer(z~(1|ID), data=x)
  x3<-data.frame(ID=as.numeric(row.names(coef(mod)$ID)), z=unlist(ranef(mod)$ID))
x3$z2<-x3$z^2
#x3$dev1<-x3$dev1-mean(x3$dev1)   
colnames(ped)<-c("ID","dam.id","sire.id")

Cmatrix <- inverseA(ped[,c("ID","dam.id","sire.id")])$Ainv
ainv<-inverseA(ped[,])

prec.1 = list(initial=log(1/2), prior="pc.prec",param=c(1,0.05), fixed=FALSE)
prec.2=list( param = c(0.1,0.01))
prec.3 = list(param = c(0.5, 0.5), fixed = FALSE)


formula = z2 ~ 1  +
  f(ID,model="generic0",
    Cmatrix=Cmatrix,
    hyper=list(
      prec=prec.3 
    )
  )



mod1.Inla = inla(formula=formula, family="gaussian",
                 data=x3,
                 control.compute=list(dic=T, config=T)
)


  # summary(mod)
  res<-data.frame(Va=1/mod1.Inla$summary.hyperpar$`0.5quant`[2]
)
  res
}

animal2<-function(x){
  ped<-x[-which(duplicated(x$ID)),c(3,2,1)]
  colnames(ped)<-c("animal","dam", "sire")
  ped$sire[ped$sire==0]<-NA
  ped$dam[ped$dam==0]<-NA  
  
  x2<-x %>% group_by(ID) %>%
    mutate(zMean = mean(z))
  x2<-as.data.frame(x2)  
  x2$dev2<-(x2$z-x2$zMean)^2
  x3<-x2 %>% group_by(ID) %>%
    summarize(dev2=mean(dev2))
  x3$ID2<-x3$ID
  
colnames(ped)<-c("ID","dam.id","sire.id")

Cmatrix <- inverseA(ped[,c("ID","dam.id","sire.id")])$Ainv
ainv<-inverseA(ped[,])

prec.2=list( param = c(0.1,0.01))
prec.3 = list(param = c(0.5, 0.5), fixed = FALSE)

#+ f(ID2 ,model="iid", hyper=list(prec=prec.2))
formula = dev2 ~ 1   +f(ID,model="generic0",
    Cmatrix=Cmatrix,
    hyper=list(
      prec=prec.2
    )
  )




mod1.Inla = inla(formula=formula, family="gaussian",
                 data=x3,
                 control.compute=list(dic=T, config=T)
)


  # summary(mod)
  res<-data.frame(Va=1/mod1.Inla$summary.hyperpar$`0.5quant`[2]
)
  res
}


```

#Scenarios

##Disruptive Selection No variance in Slopes
```{r DisruptiveSelectionNoVSlopes, cache=TRUE}
nsim=50
LastGen<-NewGen<-OldGens<-list() 
maxW<-rep(NA, nsim)

Br=1
Bd=1
xd_bar=0
xr_bar=0

Va=0.5

VBd=0.2
Vxd=1

VBr=0
Vxr=0.01

##Selection
Bl=0 
Bq=0.5
BBd=0 
BBr=0

for(i in 1:nsim){
res1<-simPed(n=200, gen=4, nrep=10, Va=Va, VBd=VBd, Vxd=Vxd, VBr=VBr, Vxr=Vxr, Br=Br, Bd=Bd, xd_bar=xd_bar, xr_bar=xr_bar)
OldGens[[i]]<-res1$d2
res2<-selection(res1, Bl=Bl, Bq=Bq, BBd=BBd, BBr=BBr)
NewGen[[i]]<-res2$d4
LastGen[[i]]<-res2$d2
maxW[i]<-res2$par$mw
}

```

```{r DisruptiveSelectionNoVSlopesObsV, include=FALSE}
vE1<-do.call(rbind.data.frame, mclapply(OldGens, obs.var2, mc.cores=4))
vE2<-do.call(rbind.data.frame, mclapply(NewGen, obs.var2, mc.cores=4))
vOb1<-do.call(rbind.data.frame, mclapply(OldGens, obs.var, mc.cores=4))
vOb2<-do.call(rbind.data.frame, mclapply(NewGen, obs.var, mc.cores=4))
Betas<-do.call(rbind.data.frame, mclapply(LastGen, selAn, mc.cores=4))
```

```{r DisruptiveSelectionNoVSlopesEstV, include=FALSE, cache=TRUE}
EVmean.1<-do.call(rbind.data.frame, mclapply(OldGens, animal, mc.cores=4))
EVdev1.1<-do.call(rbind.data.frame, mclapply(OldGens, animal1mm, mc.cores=4))
#EVdev2.1<-do.call(rbind.data.frame, mclapply(OldGens, animal1mm, mc.cores=4))

```

Generated among individual variance
```{r} 
Va + Vxd*VBd + xd_bar^2*VBd + Bd^2*Vxd
mean(vOb1$VID)
mean(vE1$VID)

2*(Va + Vxd*VBd + xd_bar^2*VBd + Bd^2*Vxd)^2
2*mean(vOb1$VID)^2
2*mean(vE1$VID)^2
```

Generated genetic variance 
```{r} 
mean(EVmean.1$Va)
Va + Bd^2*VBd

mean(2*EVmean.1$Va^2)
2*(Va + Bd^2*VBd)^2

Va^2 + 4*(Va + VBd*Vxd + Vxd) + (VBd*Vxd + Vxd)^2   

Va^2 + 4*Vbd*Vxd^2   

4*Vbd*Vxd^2

hist(EVdev1.1$Va)
mean(EVdev1.1$Va)

```

Generated selection 
```{r} 
mean(Bq)/mean(maxW)
mean(Betas$bv1)  
```

Change in among individual variance
```{r} 
mean(vOb2$VID - vOb1$VID)
mean(vOb2$Va - vOb1$Va)
mean(vE2$VID - vE1$VID)

Bq/mean(maxW)*2*(Va + Bd^2*VBd)^2/2
mean(Betas$bv1*2*(Va + Bd^2*VBd)^2)/2
mean(Betas$bv1*2*EVmean.1$Va^2)/2
```


Generated within individual variance 
```{r, include=FALSE} 
#mean(EV0$Vdev1)
mean(vOb1$VRes)
Vxr*VBr + xr_bar^2*VBr + Br^2*Vxr

mean(2*vOb1$VRes^2)
2*(xr_bar*VBr + xr_bar^2*VBr + Br^2*Vxr)^2
```

Generated selection and change in Br
```{r, include=FALSE} 
BBr/mean(maxW)
mean(vOb2$Br)-mean(vOb1$Br)
BBr/mean(maxW)*VBr/2

```

Change in within individual variance
```{r, include=FALSE} 
mean(vOb1$VRes-vOb2$VRes)
mean(Betas$bv2*VBr)/2
#mean(Betas$bv2*EVdev2$Va)/2

```

Important to note that within individual variance will cause a mistmatch in estimates



##Disruptive Selection Variance in slopes
```{r DisruptiveSelectionVSlopes, cache=TRUE}
#nsim=200
LastGen<-NewGen<-OldGens<-list() 
maxW<-rep(NA, nsim)

Br=1
Bd=4
xd_bar=2
xr_bar=1

Va=1

VBd=0.25
Vxd=0.2

VBr=0
Vxr=1

##Selection
Bl=0 
Bq=0.5
BBd=0 
BBr=0

for(i in 1:nsim){
res1<-simPed(n=200, gen=4, nrep=10, Va=Va, VBd=VBd, Vxd=Vxd, VBr=VBr, Vxr=Vxr, Br=Br, Bd=Bd, xd_bar=xd_bar, xr_bar=xr_bar)
OldGens[[i]]<-res1$d2
res2<-selection(res1, Bl=Bl, Bq=Bq, BBd=BBd, BBr=BBr)
NewGen[[i]]<-res2$d4
LastGen[[i]]<-res2$d2
maxW[i]<-res2$par$mw
}

```

```{r DisruptiveSelectionVSlopesObsV, include=FALSE}

vE1<-do.call(rbind.data.frame, mclapply(OldGens, obs.var2, mc.cores=4))
vE2<-do.call(rbind.data.frame, mclapply(NewGen, obs.var2, mc.cores=4))
vOb1<-do.call(rbind.data.frame, mclapply(OldGens, obs.var, mc.cores=4))
vOb2<-do.call(rbind.data.frame, mclapply(NewGen, obs.var, mc.cores=4))
Betas<-do.call(rbind.data.frame, mclapply(LastGen, selAn, mc.cores=4))
```

```{r DisruptiveSelectionVSlopesEstV, include=FALSE, cache=TRUE}
EVmean.2<-do.call(rbind.data.frame, mclapply(OldGens, animal, mc.cores=4))
#EVdev1.2<-do.call(rbind.data.frame, mclapply(OldGens, animal1, mc.cores=4))
#EVdev2.2<-do.call(rbind.data.frame, mclapply(OldGens, animal2, mc.cores=4))
```

Generated among individual variance
```{r} 
Va + Vxd*VBd + xd_bar^2*VBd + Bd^2*Vxd
mean(vOb1$VID)
mean(vE1$VID)

2*(Va + Vxd*VBd + xd_bar^2*VBd + Bd^2*Vxd)^2
2*mean(vOb1$VID)^2
2*mean(vE1$VID)^2
```

Generated genetic variance 
```{r} 
mean(EVmean.2$Va)
Va + Bd^2*VBd

mean(2*EVmean.2$Va^2)
2*(Va + Bd^2*VBd)^2
  
```

Generated selection 
```{r} 
mean(Bq)/mean(maxW)
mean(Betas$bv1)  
```

Change in among individual variance
```{r} 
mean(vOb2$VID - vOb1$VID)
mean(vOb2$Va - vOb1$Va)
mean(vE2$VID - vE1$VID)

Bq/mean(maxW)*2*(Va + Bd^2*VBd)^2/2
mean(Betas$bv1*2*(Va + Bd^2*VBd)^2)/2
mean(Betas$bv1*2*EVmean.2$Va^2)/2
```

Generated within individual variance 
```{r, include=FALSE} 
#mean(EV0$Vdev1)
mean(vOb1$VRes)
Vxr*VBr + xr_bar^2*VBr + Br^2*Vxr

mean(2*vOb1$VRes^2)
2*(xr_bar*VBr + xr_bar^2*VBr + Br^2*Vxr)^2
```

Generated selection and change in Br
```{r, include=FALSE} 
BBr/mean(maxW)
mean(vOb2$Br)-mean(vOb1$Br)
BBr/mean(maxW)*VBr/2

```

Change in within individual variance
```{r, include=FALSE} 
mean(vOb1$VRes-vOb2$VRes)
mean(Betas$bv2*VBr)/2
#mean(Betas$bv2*EVdev2$Va)/2
```


##Selection for stability
```{r StabilitySelectionVSlopes, cache=TRUE}
nsim=100
LastGen<-NewGen<-OldGens<-list() 
maxW<-rep(NA, nsim)

Br=1
Bd=1
xd_bar=0
xr_bar=0

Va=2

VBd=0
Vxd=0.2

VBr=0
Vxr=1

##Selection
Bl=0 
Bq=0
BBd=0 
BBr=0

for(i in 1:nsim){
res1<-simPed(n=150, gen=5, nrep=100, Va=Va, VBd=VBd, Vxd=Vxd, VBr=VBr, Vxr=Vxr, Br=Br, Bd=Bd, xd_bar=xd_bar, xr_bar=xr_bar)
OldGens[[i]]<-res1$d2
res2<-selection(res1, Bl=Bl, Bq=Bq, BBd=BBd, BBr=BBr)
NewGen[[i]]<-res2$d4
LastGen[[i]]<-res2$d2
maxW[i]<-res2$par$mw
}

```

```{r StabilitySelectionVSlopesObsV, include=FALSE}
vE1<-do.call(rbind.data.frame, mclapply(OldGens, obs.var2, mc.cores=4))
vE2<-do.call(rbind.data.frame, mclapply(NewGen, obs.var2, mc.cores=4))
vOb1<-do.call(rbind.data.frame, mclapply(OldGens, obs.var, mc.cores=4))
vOb2<-do.call(rbind.data.frame, mclapply(NewGen, obs.var, mc.cores=4))
Betas<-do.call(rbind.data.frame, mclapply(LastGen, selAn, mc.cores=4))
```

```{r StabilitySelectionVSlopesEstV, include=FALSE, cache=TRUE}
EVmean.3<-do.call(rbind.data.frame, mclapply(OldGens, animal, mc.cores=4))
EVdev1.3<-do.call(rbind.data.frame, mclapply(OldGens, animal1, mc.cores=4))
#EVdev2.3<-do.call(rbind.data.frame, mclapply(OldGens, animal2, mc.cores=4))
```

Generated among individual variance
```{r, include=FALSE} 
Va + Vxd*VBd + xd_bar^2*VBd + Bd^2*Vxd
mean(vOb1$VID)
mean(vE1$VID)

VPe = Vxd*VBd + xd_bar^2*VBd + Bd^2*Vxd

2*(Va + Vxd*VBd + xd_bar^2*VBd + Bd^2*Vxd)^2

2*Va^2 + 2*(VPe*Va + VPe) + 2*VPe^2

2*mean(vOb1$VID)^2
mean(vOb1$VIDsqrt)

2*mean(vE1$VID)^2
```

Generated genetic variance 
```{r, include=FALSE} 
mean(EVmean.3$Va)
Va + Bd^2*VBd

mean(2*EVmean.3$Va^2)
2*(Va + Bd^2*VBd)^2

mean(EVdev1.3$Va)


VBd  
```

Generated selection 
```{r, include=FALSE} 
mean(Bq)/mean(maxW)
mean(Betas$bv1)  
```

Change in among individual variance
```{r, include=FALSE} 
mean(vOb2$VID - vOb1$VID)
mean(vOb2$Va - vOb1$Va)
mean(vE2$VID - vE1$VID)

Bq/mean(maxW)*2*(Va + Bd^2*VBd)^2/2
mean(Betas$bv1*2*(Va + Bd^2*VBd)^2)/2
mean(Betas$bv1*2*EVmean.3$Va^2)/2
```

Generated within individual variance 
```{r} 
#mean(EV0$Vdev1)
(Vxr*VBr + xr_bar^2*VBr + Br^2*Vxr)
mean(vOb1$VRes)
mean(vE1$VRes)

2*(xr_bar*VBr + xr_bar^2*VBr + Br^2*Vxr)^2
mean(2*vOb1$VRes^2)
mean(2*vE1$VRes^2)

```

Generated selection and change in Br
```{r} 
BBr/mean(maxW)
mean(Betas$bv2)

mean(vOb2$Br)-mean(vOb1$Br)


```

Change in within individual variance
```{r} 
mean(vOb2$VRes-vOb1$VRes)
mean(Betas$bv2)*mean(EVdev2.3$Va)/2

BBr/mean(maxW)*VBr/2*(Vxr*VBr + xr_bar^2*VBr + Br^2*Vxr)
mean(Betas$bv2*VBr/2*mean(vOb1$VRes))

#mean(Betas$bv2*EVdev2$Va)/2
```


